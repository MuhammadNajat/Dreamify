{"version":3,"file":"generate-schema.js","sourceRoot":"","sources":["../../../src/cli/services/generate-schema.ts"],"names":[],"mappings":"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","sourcesContent":["import {fetchOrCreateOrganizationApp} from './context.js'\nimport {fetchPartnersSession} from './context/partner-account-info.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {getAppIdentifiers} from '../models/app/identifiers.js'\nimport {\n  ApiSchemaDefinitionQuery,\n  ApiSchemaDefinitionQuerySchema,\n  ApiSchemaDefinitionQueryVariables,\n} from '../api/graphql/functions/api_schema_definition.js'\nimport {\n  TargetSchemaDefinitionQuery,\n  TargetSchemaDefinitionQuerySchema,\n  TargetSchemaDefinitionQueryVariables,\n} from '../api/graphql/functions/target_schema_definition.js'\nimport {ExtensionInstance} from '../models/extensions/extension-instance.js'\nimport {FunctionConfigType} from '../models/extensions/specifications/function.js'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\nimport {isTerminalInteractive} from '@shopify/cli-kit/node/context/local'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {outputContent, outputInfo} from '@shopify/cli-kit/node/output'\nimport {writeFile} from '@shopify/cli-kit/node/fs'\nimport {joinPath} from '@shopify/cli-kit/node/path'\n\ninterface GenerateSchemaOptions {\n  app: AppInterface\n  extension: ExtensionInstance<FunctionConfigType>\n  apiKey?: string\n  stdout: boolean\n  path: string\n}\n\nexport async function generateSchemaService(options: GenerateSchemaOptions) {\n  const {extension, app} = options\n  const partnersSession = await fetchPartnersSession()\n  const token = partnersSession.token\n  const {api_version: version, type, targeting} = extension.configuration\n  let apiKey = options.apiKey || getAppIdentifiers({app}).app\n  const stdout = options.stdout\n\n  if (!apiKey) {\n    if (!isTerminalInteractive()) {\n      throw new AbortError(\n        outputContent`No Client ID was provided.`,\n        outputContent`Provide a Client ID with the --client-id flag.`,\n      )\n    }\n\n    apiKey = (await fetchOrCreateOrganizationApp(app, partnersSession)).apiKey\n  }\n\n  const usingTargets = Boolean(targeting?.length)\n  const definition = await (usingTargets\n    ? generateSchemaFromTarget({\n        localIdentifier: extension.localIdentifier,\n        token,\n        apiKey,\n        target: targeting![0]!.target,\n        version,\n      })\n    : generateSchemaFromType({localIdentifier: extension.localIdentifier, token, apiKey, type, version}))\n\n  if (stdout) {\n    outputInfo(definition)\n  } else {\n    const outputPath = joinPath(options.path, 'schema.graphql')\n    await writeFile(outputPath, definition)\n    outputInfo(`GraphQL Schema for ${extension.localIdentifier} written to ${outputPath}`)\n  }\n}\n\ninterface BaseGenerateSchemaOptions {\n  localIdentifier: string\n  token: string\n  apiKey: string\n  version: string\n}\n\ninterface GenerateSchemaFromTargetOptions extends BaseGenerateSchemaOptions {\n  target: string\n}\n\nasync function generateSchemaFromTarget({\n  localIdentifier,\n  token,\n  apiKey,\n  target,\n  version,\n}: GenerateSchemaFromTargetOptions): Promise<string> {\n  const query = TargetSchemaDefinitionQuery\n  const variables: TargetSchemaDefinitionQueryVariables = {\n    apiKey,\n    target,\n    version,\n  }\n  const response: TargetSchemaDefinitionQuerySchema = await partnersRequest(query, token, variables)\n\n  if (!response.definition) {\n    throw new AbortError(\n      outputContent`A schema could not be generated for ${localIdentifier}`,\n      outputContent`Check that the Function targets and version are valid.`,\n    )\n  }\n\n  return response.definition\n}\n\ninterface GenerateSchemaFromType extends BaseGenerateSchemaOptions {\n  type: string\n}\n\nasync function generateSchemaFromType({\n  localIdentifier,\n  token,\n  apiKey,\n  version,\n  type,\n}: GenerateSchemaFromType): Promise<string> {\n  const query = ApiSchemaDefinitionQuery\n  const variables: ApiSchemaDefinitionQueryVariables = {\n    apiKey,\n    version,\n    type,\n  }\n  const response: ApiSchemaDefinitionQuerySchema = await partnersRequest(query, token, variables)\n\n  if (!response.definition) {\n    throw new AbortError(\n      outputContent`A schema could not be generated for ${localIdentifier}`,\n      outputContent`Check that the Function API type and version are valid.`,\n    )\n  }\n\n  return response.definition\n}\n"]}