{"version":3,"file":"release.js","sourceRoot":"","sources":["../../../src/cli/services/release.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,oBAAoB,EAAC,MAAM,cAAc,CAAA;AACjD,OAAO,EAAC,oBAAoB,EAAC,MAAM,2BAA2B,CAAA;AAE9D,OAAO,EAAC,UAAU,EAAwC,MAAM,+BAA+B,CAAA;AAC/F,OAAO,EAAC,oBAAoB,EAAC,MAAM,uBAAuB,CAAA;AAC1D,OAAO,EAAC,eAAe,EAAC,MAAM,oCAAoC,CAAA;AAClE,OAAO,EAAC,WAAW,EAAE,aAAa,EAAE,WAAW,EAAY,MAAM,0BAA0B,CAAA;AAuB3F,MAAM,CAAC,KAAK,UAAU,OAAO,CAAC,OAAuB;IACnD,MAAM,EAAC,KAAK,EAAE,GAAG,EAAE,WAAW,EAAC,GAAG,MAAM,oBAAoB,CAAC,OAAO,CAAC,CAAA;IAErE,MAAM,EAAC,YAAY,EAAE,cAAc,EAAC,GAAG,MAAM,oBAAoB,CAAC,WAAW,CAAC,MAAM,EAAE,OAAO,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;IAE7G,MAAM,oBAAoB,CAAC,WAAW,CAAC,KAAK,EAAE,YAAY,CAAC,CAAA;IAK3D,MAAM,SAAS,GAAwB;QACrC,MAAM,EAAE,WAAW,CAAC,MAAM;QAC1B,YAAY,EAAE,cAAc,CAAC,EAAE;KAChC,CAAA;IAED,MAAM,KAAK,GAAG;QACZ;YACE,KAAK,EAAE,mBAAmB;YAC1B,IAAI,EAAE,KAAK,EAAE,OAAgB,EAAE,EAAE;gBAC/B,OAAO,CAAC,UAAU,GAAG,MAAM,eAAe,CAAC,UAAU,EAAE,KAAK,EAAE,SAAS,CAAC,CAAA;YAC1E,CAAC;SACF;KACF,CAAA;IAED,MAAM,EACJ,UAAU,EAAE,EAAC,UAAU,EAAE,OAAO,EAAC,GAClC,GAAG,MAAM,WAAW,CAAU,KAAK,CAAC,CAAA;IAErC,MAAM,cAAc,GAAc;QAChC,EAAC,IAAI,EAAE,EAAC,KAAK,EAAE,cAAc,CAAC,UAAU,EAAE,GAAG,EAAE,cAAc,CAAC,QAAQ,EAAC,EAAC;QACxE,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,cAAc,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,EAAE;KAC5D,CAAA;IAED,IAAI,OAAO,CAAC,UAAU,EAAE,MAAM,GAAG,CAAC,EAAE;QAClC,WAAW,CAAC;YACV,QAAQ,EAAE,+BAA+B;YACzC,IAAI,EAAE;gBACJ,GAAG,cAAc;gBACjB,GAAG,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,GAAG,OAAO,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;aAC3G;SACF,CAAC,CAAA;KACH;SAAM;QACL,aAAa,CAAC;YACZ,QAAQ,EAAE,4BAA4B;YACtC,IAAI,EAAE,cAAc;SACrB,CAAC,CAAA;KACH;AACH,CAAC","sourcesContent":["import {ensureReleaseContext} from './context.js'\nimport {versionDiffByVersion} from './release/version-diff.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {AppRelease, AppReleaseSchema, AppReleaseVariables} from '../api/graphql/app_release.js'\nimport {confirmReleasePrompt} from '../prompts/release.js'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\nimport {renderError, renderSuccess, renderTasks, TokenItem} from '@shopify/cli-kit/node/ui'\nimport {Config} from '@oclif/core'\n\ninterface ReleaseOptions {\n  /** The app to be built and uploaded */\n  app: AppInterface\n\n  /** API key of the app in Partners admin */\n  apiKey?: string\n\n  /** If true, ignore any cached appId or extensionId */\n  reset: boolean\n\n  /** If true, proceed with deploy without asking for confirmation */\n  force: boolean\n\n  /** App version tag */\n  version: string\n\n  /** Config from the Oclif command */\n  commandConfig: Config\n}\n\nexport async function release(options: ReleaseOptions) {\n  const {token, app, partnersApp} = await ensureReleaseContext(options)\n\n  const {versionsDiff, versionDetails} = await versionDiffByVersion(partnersApp.apiKey, options.version, token)\n\n  await confirmReleasePrompt(partnersApp.title, versionsDiff)\n  interface Context {\n    appRelease: AppReleaseSchema\n  }\n\n  const variables: AppReleaseVariables = {\n    apiKey: partnersApp.apiKey,\n    appVersionId: versionDetails.id,\n  }\n\n  const tasks = [\n    {\n      title: 'Releasing version',\n      task: async (context: Context) => {\n        context.appRelease = await partnersRequest(AppRelease, token, variables)\n      },\n    },\n  ]\n\n  const {\n    appRelease: {appRelease: release},\n  } = await renderTasks<Context>(tasks)\n\n  const linkAndMessage: TokenItem = [\n    {link: {label: versionDetails.versionTag, url: versionDetails.location}},\n    versionDetails.message ? `\\n${versionDetails.message}` : '',\n  ]\n\n  if (release.userErrors?.length > 0) {\n    renderError({\n      headline: \"Version couldn't be released.\",\n      body: [\n        ...linkAndMessage,\n        `${linkAndMessage.length > 0 ? '\\n\\n' : ''}${release.userErrors.map((error) => error.message).join(', ')}`,\n      ],\n    })\n  } else {\n    renderSuccess({\n      headline: 'Version released to users.',\n      body: linkAndMessage,\n    })\n  }\n}\n"]}