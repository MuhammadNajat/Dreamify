{"version":3,"file":"push.js","sourceRoot":"","sources":["../../../../../src/cli/services/app/config/push.ts"],"names":[],"mappings":"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","sourcesContent":["import {PushConfig, PushConfigSchema, PushConfigVariables} from '../../../api/graphql/push_config.js'\nimport {ClearScopesSchema, clearRequestedScopes} from '../../../api/graphql/clear_requested_scopes.js'\nimport {App, GetConfig, GetConfigQuerySchema} from '../../../api/graphql/get_config.js'\nimport {\n  AppConfiguration,\n  CurrentAppConfiguration,\n  isCurrentAppSchema,\n  usesLegacyScopesBehavior,\n  getAppScopesArray,\n} from '../../../models/app/app.js'\nimport {DeleteAppProxySchema, deleteAppProxy} from '../../../api/graphql/app_proxy_delete.js'\nimport {confirmPushChanges} from '../../../prompts/config.js'\nimport {logMetadataForLoadedContext, renderCurrentlyUsedConfigInfo} from '../../context.js'\nimport {fetchOrgFromId} from '../../dev/fetch.js'\nimport {fetchPartnersSession} from '../../context/partner-account-info.js'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {renderSuccess} from '@shopify/cli-kit/node/ui'\nimport {OutputMessage} from '@shopify/cli-kit/node/output'\nimport {basename} from '@shopify/cli-kit/node/path'\n\nexport interface PushOptions {\n  configuration: AppConfiguration\n  force: boolean\n}\n\nconst FIELD_NAMES: {[key: string]: string} = {\n  title: 'name',\n  api_key: 'client_id',\n  redirect_url_whitelist: 'auth > redirect_urls',\n  requested_access_scopes: 'access_scopes > scopes',\n  webhook_api_version: 'webhooks > api_version',\n  gdpr_webhooks: 'webhooks.privacy_compliance',\n  'gdpr_webhooks,customer_deletion_url': 'webhooks.privacy_compliance > customer_deletion_url',\n  'gdpr_webhooks,customer_data_request_url': 'webhooks.privacy_compliance > customer_data_request_url',\n  'gdpr_webhooks,shop_deletion_url': 'webhooks.privacy_compliance > shop_deletion_url',\n  proxy_sub_path: 'app_proxy > subpath',\n  proxy_sub_path_prefix: 'app_proxy > prefix',\n  proxy_url: 'app_proxy > url',\n  preferences_url: 'app_preferences > url',\n}\n\nexport async function pushConfig(options: PushOptions) {\n  const {configuration} = options\n  if (!isCurrentAppSchema(configuration)) return\n\n  const partnersSession = await fetchPartnersSession()\n  const token = partnersSession.token\n  const configFileName = isCurrentAppSchema(configuration) ? basename(configuration.path) : undefined\n\n  const queryVariables = {apiKey: configuration.client_id}\n  const queryResult: GetConfigQuerySchema = await partnersRequest(GetConfig, token, queryVariables)\n\n  if (!queryResult.app) abort(\"Couldn't find app. Make sure you have a valid client ID.\")\n  const {app} = queryResult\n\n  const {businessName: org} = await fetchOrgFromId(app.organizationId, partnersSession)\n  renderCurrentlyUsedConfigInfo({org, appName: app.title, configFile: configFileName})\n\n  if (!(await confirmPushChanges(options, app))) return\n\n  const variables = getMutationVars(app, configuration)\n\n  const result: PushConfigSchema = await partnersRequest(PushConfig, token, variables)\n\n  if (result.appUpdate.userErrors.length > 0) {\n    const errors = result.appUpdate.userErrors\n      .map((error) => {\n        const [_, ...fieldPath] = error.field || []\n        const mappedName = FIELD_NAMES[fieldPath.join(',')] || fieldPath.join(', ')\n        const fieldName = mappedName ? `${mappedName}: ` : ''\n        return `${fieldName}${error.message}`\n      })\n      .join('\\n')\n    abort(errors)\n  }\n\n  const shouldDeleteScopes =\n    app.requestedAccessScopes &&\n    (configuration.access_scopes?.scopes === undefined || usesLegacyScopesBehavior(configuration))\n\n  if (shouldDeleteScopes) {\n    const clearResult: ClearScopesSchema = await partnersRequest(clearRequestedScopes, token, {apiKey: app.apiKey})\n\n    if (clearResult.appRequestedAccessScopesClear?.userErrors?.length > 0) {\n      const errors = clearResult.appRequestedAccessScopesClear.userErrors.map((error) => error.message).join(', ')\n      abort(errors)\n    }\n  }\n\n  if (!configuration.app_proxy && app.appProxy) {\n    const deleteResult: DeleteAppProxySchema = await partnersRequest(deleteAppProxy, token, {apiKey: app.apiKey})\n\n    if (deleteResult?.userErrors?.length > 0) {\n      const errors = deleteResult.userErrors.map((error) => error.message).join(', ')\n      abort(errors)\n    }\n  }\n\n  await logMetadataForLoadedContext(app)\n\n  renderSuccess({\n    headline: `Updated your app config for ${configuration.name}`,\n    body: [`Your ${configFileName} config is live for your app users.`],\n  })\n}\n\nconst getMutationVars = (app: App, configuration: CurrentAppConfiguration) => {\n  let webhookApiVersion\n  let gdprWebhooks\n\n  if (app.betas?.declarativeWebhooks) {\n    // These fields will be updated by the deploy command\n    webhookApiVersion = app.webhookApiVersion\n    gdprWebhooks = app.gdprWebhooks\n  } else {\n    webhookApiVersion = configuration.webhooks?.api_version\n    gdprWebhooks = {\n      customerDeletionUrl: configuration.webhooks?.privacy_compliance?.customer_deletion_url,\n      customerDataRequestUrl: configuration.webhooks?.privacy_compliance?.customer_data_request_url,\n      shopDeletionUrl: configuration.webhooks?.privacy_compliance?.shop_deletion_url,\n    }\n  }\n\n  const variables: PushConfigVariables = {\n    apiKey: configuration.client_id,\n    title: configuration.name,\n    applicationUrl: configuration.application_url,\n    webhookApiVersion,\n    redirectUrlAllowlist: configuration.auth?.redirect_urls ?? null,\n    embedded: configuration.embedded ?? app.embedded,\n    gdprWebhooks,\n    posEmbedded: configuration.pos?.embedded ?? false,\n    preferencesUrl: configuration.app_preferences?.url ?? null,\n  }\n\n  if (!usesLegacyScopesBehavior(configuration) && configuration.access_scopes?.scopes !== undefined) {\n    variables.requestedAccessScopes = getAppScopesArray(configuration)\n  }\n\n  if (configuration.app_proxy) {\n    variables.appProxy = {\n      proxySubPath: configuration.app_proxy.subpath,\n      proxySubPathPrefix: configuration.app_proxy.prefix,\n      proxyUrl: configuration.app_proxy.url,\n    }\n  }\n\n  return variables\n}\n\nexport const abort = (errorMessage: OutputMessage) => {\n  throw new AbortError(errorMessage)\n}\n"]}