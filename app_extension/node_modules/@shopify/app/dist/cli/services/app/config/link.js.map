{"version":3,"file":"link.js","sourceRoot":"","sources":["../../../../../src/cli/services/app/config/link.ts"],"names":[],"mappings":"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","sourcesContent":["import {saveCurrentConfig} from './use.js'\nimport {\n  AppConfiguration,\n  AppInterface,\n  EmptyApp,\n  isCurrentAppSchema,\n  isLegacyAppSchema,\n} from '../../../models/app/app.js'\nimport {OrganizationApp} from '../../../models/organization.js'\nimport {selectConfigName} from '../../../prompts/config.js'\nimport {loadLocalExtensionsSpecifications} from '../../../models/extensions/load-specifications.js'\nimport {getAppConfigurationFileName, loadApp} from '../../../models/app/loader.js'\nimport {InvalidApiKeyErrorMessage, fetchOrCreateOrganizationApp, logMetadataForLoadedContext} from '../../context.js'\nimport {fetchAppDetailsFromApiKey} from '../../dev/fetch.js'\nimport {configurationFileNames} from '../../../constants.js'\nimport {writeAppConfigurationFile} from '../write-app-configuration-file.js'\nimport {getCachedCommandInfo} from '../../local-storage.js'\nimport {fetchPartnersSession} from '../../context/partner-account-info.js'\nimport {Config} from '@oclif/core'\nimport {renderSuccess} from '@shopify/cli-kit/node/ui'\nimport {joinPath} from '@shopify/cli-kit/node/path'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {formatPackageManagerCommand} from '@shopify/cli-kit/node/output'\n\nexport interface LinkOptions {\n  commandConfig: Config\n  directory: string\n  apiKey?: string\n  configName?: string\n}\n\nexport default async function link(options: LinkOptions, shouldRenderSuccess = true): Promise<AppConfiguration> {\n  const localApp = await loadAppConfigFromDefaultToml(options)\n  const directory = localApp?.directory || options.directory\n  const remoteApp = await loadRemoteApp(localApp, options.apiKey, directory)\n\n  const configFileName = await loadConfigurationFileName(remoteApp, options, localApp)\n  const configFilePath = joinPath(directory, configFileName)\n\n  const configuration = mergeAppConfiguration({...localApp.configuration, path: configFilePath}, remoteApp)\n\n  await writeAppConfigurationFile(configuration)\n\n  await saveCurrentConfig({configFileName, directory})\n\n  if (shouldRenderSuccess) {\n    renderSuccess({\n      headline: `${configFileName} is now linked to \"${remoteApp.title}\" on Shopify`,\n      body: `Using ${configFileName} as your default config.`,\n      nextSteps: [\n        [`Make updates to ${configFileName} in your local project`],\n        [\n          'To upload your config, run',\n          {command: formatPackageManagerCommand(localApp.packageManager, 'shopify app config push')},\n        ],\n      ],\n      reference: [\n        {\n          link: {\n            label: 'App configuration',\n            url: 'https://shopify.dev/docs/apps/tools/cli/configuration',\n          },\n        },\n      ],\n    })\n  }\n\n  await logMetadataForLoadedContext(remoteApp)\n\n  return configuration\n}\n\nasync function loadAppConfigFromDefaultToml(options: LinkOptions): Promise<AppInterface> {\n  try {\n    const specifications = await loadLocalExtensionsSpecifications(options.commandConfig)\n    const app = await loadApp({\n      specifications,\n      directory: options.directory,\n      mode: 'report',\n      configName: configurationFileNames.app,\n    })\n    return app\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch (error) {\n    return new EmptyApp()\n  }\n}\n\nasync function loadRemoteApp(\n  localApp: AppInterface,\n  apiKey: string | undefined,\n  directory?: string,\n): Promise<OrganizationApp> {\n  const partnersSession = await fetchPartnersSession()\n  if (!apiKey) {\n    return fetchOrCreateOrganizationApp(localApp, partnersSession, directory)\n  }\n  const app = await fetchAppDetailsFromApiKey(apiKey, partnersSession.token)\n  if (!app) {\n    const errorMessage = InvalidApiKeyErrorMessage(apiKey)\n    throw new AbortError(errorMessage.message, errorMessage.tryMessage)\n  }\n  return app\n}\n\nasync function loadConfigurationFileName(\n  remoteApp: OrganizationApp,\n  options: LinkOptions,\n  localApp: AppInterface,\n): Promise<string> {\n  const cache = getCachedCommandInfo()\n\n  if (!cache?.askConfigName && cache?.selectedToml) return cache.selectedToml as string\n\n  if (options.configName) {\n    return getAppConfigurationFileName(options.configName)\n  }\n\n  if (!localApp.configuration || (localApp && isLegacyAppSchema(localApp.configuration))) {\n    return configurationFileNames.app\n  }\n\n  const configName = await selectConfigName(localApp.directory || options.directory, remoteApp.title)\n  return `shopify.app.${configName}.toml`\n}\n\nexport function mergeAppConfiguration(\n  appConfiguration: AppConfiguration,\n  remoteApp: OrganizationApp,\n): AppConfiguration {\n  const result: AppConfiguration = {\n    path: appConfiguration.path,\n    client_id: remoteApp.apiKey,\n    name: remoteApp.title,\n    application_url: remoteApp.applicationUrl.replace(/\\/$/, ''),\n    embedded: remoteApp.embedded === undefined ? true : remoteApp.embedded,\n    webhooks: {\n      api_version: remoteApp.webhookApiVersion || '2023-07',\n    },\n    auth: {\n      redirect_urls: remoteApp.redirectUrlWhitelist,\n    },\n    pos: {\n      embedded: remoteApp.posEmbedded || false,\n    },\n  }\n\n  const hasAnyPrivacyWebhook =\n    remoteApp.gdprWebhooks?.customerDataRequestUrl ||\n    remoteApp.gdprWebhooks?.customerDeletionUrl ||\n    remoteApp.gdprWebhooks?.shopDeletionUrl\n\n  if (hasAnyPrivacyWebhook) {\n    result.webhooks.privacy_compliance = {\n      customer_data_request_url: remoteApp.gdprWebhooks?.customerDataRequestUrl,\n      customer_deletion_url: remoteApp.gdprWebhooks?.customerDeletionUrl,\n      shop_deletion_url: remoteApp.gdprWebhooks?.shopDeletionUrl,\n    }\n  }\n\n  if (remoteApp.appProxy?.url) {\n    result.app_proxy = {\n      url: remoteApp.appProxy.url,\n      subpath: remoteApp.appProxy.subPath,\n      prefix: remoteApp.appProxy.subPathPrefix,\n    }\n  }\n\n  if (remoteApp.preferencesUrl) {\n    result.app_preferences = {url: remoteApp.preferencesUrl}\n  }\n\n  result.access_scopes = getAccessScopes(appConfiguration, remoteApp)\n\n  if (appConfiguration.extension_directories) {\n    result.extension_directories = appConfiguration.extension_directories\n  }\n\n  if (appConfiguration.web_directories) {\n    result.web_directories = appConfiguration.web_directories\n  }\n\n  return result\n}\n\nconst getAccessScopes = (appConfiguration: AppConfiguration, remoteApp: OrganizationApp) => {\n  // if we have upstream scopes, use them\n  if (remoteApp.requestedAccessScopes) {\n    return {\n      scopes: remoteApp.requestedAccessScopes.join(','),\n    }\n    // if we have scopes locally and not upstream, preserve them but don't push them upstream (legacy is true)\n  } else if (isLegacyAppSchema(appConfiguration) && appConfiguration.scopes) {\n    return {\n      scopes: appConfiguration.scopes,\n      use_legacy_install_flow: true,\n    }\n  } else if (isCurrentAppSchema(appConfiguration) && appConfiguration.access_scopes?.scopes) {\n    return {\n      scopes: appConfiguration.access_scopes.scopes,\n      use_legacy_install_flow: true,\n    }\n    // if we can't find scopes or have to fall back, omit setting a scope and set legacy to true\n  } else {\n    return {\n      use_legacy_install_flow: true,\n    }\n  }\n}\n"]}